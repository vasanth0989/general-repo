import groovy.json.JsonOutput

tasks.register("generateBomForNexusIq") {
    group = "verification"
    description = "Generates CycloneDX SBOM (bom.json) into build/libs for NexusIQ Jenkins scan."

    doLast {
        def components = configurations.runtimeClasspath.resolvedConfiguration
            .resolvedArtifacts
            .collect { artifact ->
                def id = artifact.moduleVersion.id
                [
                    "bom-ref": "pkg:maven/${id.group}/${id.name}@${id.version}",
                    type     : "library",
                    group    : id.group,
                    name     : id.name,
                    version  : id.version,
                    purl     : "pkg:maven/${id.group}/${id.name}@${id.version}"
                ]
            }

        def sbom = [
            bomFormat   : "CycloneDX",
            specVersion : "1.4",
            version     : 1,
            metadata    : [
                component: [
                    type   : "application",
                    name   : project.name,
                    version: project.version.toString()
                ]
            ],
            components  : components
        ]

        def bomFile = file("$buildDir/libs/bom.json")   // âœ… IMPORTANT: Sonatype-recognized name
        bomFile.parentFile.mkdirs()
        bomFile.text = JsonOutput.prettyPrint(JsonOutput.toJson(sbom))

        println "NexusIQ SBOM generated at: ${bomFile} (${components.size()} components)"
    }
}
